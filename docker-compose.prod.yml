# Production override — used on VPS behind Traefik
# Pulls pre-built images from GHCR, routes via Traefik reverse proxy
#
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  api:
    image: ghcr.io/ampynjord/starvis-api:latest
    build: !reset null
    ports: !reset []
    networks:
      - default
      - traefik-network
    labels:
      traefik.enable: "true"
      traefik.http.routers.starvis-api.rule: "Host(`starvis-api.ampynjord.bzh`)"
      traefik.http.routers.starvis-api.entrypoints: "websecure"
      traefik.http.routers.starvis-api.tls.certresolver: "letsencrypt"
      traefik.http.services.starvis-api.loadbalancer.server.port: "3000"

  ihm:
    image: ghcr.io/ampynjord/starvis-ihm:latest
    build: !reset null
    ports: !reset []
    # Override healthcheck to use 127.0.0.1 (Alpine resolves localhost to IPv6)
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:80/"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3
    networks:
      - default
      - traefik-network
    labels:
      traefik.enable: "true"
      traefik.http.routers.starvis-ihm.rule: "Host(`starvis.ampynjord.bzh`)"
      traefik.http.routers.starvis-ihm.entrypoints: "websecure"
      traefik.http.routers.starvis-ihm.tls.certresolver: "letsencrypt"
      traefik.http.services.starvis-ihm.loadbalancer.server.port: "80"

  mysql:
    # No Traefik — internal only, no exposed ports in prod
    ports: !reset []

networks:
  traefik-network:
    external: true
